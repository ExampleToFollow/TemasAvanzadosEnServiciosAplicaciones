<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Aula - Temperatura y Humedad</title>

  <!-- Enlace a Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background-color: #F7F6F3;
    }

    header {
      background-color: #000;
      text-align: center;
      padding: 20px 0;
    }

    header img {
      width: 80%;
      max-width: 600px;
      height: auto;
    }

    nav {
      background-color: #f5f5f5;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      border-bottom: 2px solid #ccc;
    }

    nav a {
      text-decoration: none;
      font-weight: bold;
      color: #8A7D75;
      padding: 10px 20px;
      border-radius: 5px;
    }

    .active {
      background-color: #00CFC1;
      color: white;
    }

    .main {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    .main h2 {
      font-family: 'Courier New', Courier, monospace;
      font-size: 36px;
      color: #9AAE02;
      text-shadow: 1px 1px 1px #00000033;
      text-align: center;
      margin-bottom: 20px;
    }

    .card {
      background-color: #212529;
      color: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 600px;
      background-image: url('https://img.freepik.com/vector-premium/fondo-cielo-nocturno-muchas-estrellas_135176-451.jpg?w=900');
      background-size: cover;
      background-position: center;
      text-align: center;
      margin-bottom: 40px;
    }

    .card h3 {
      font-size: 48px;
      margin: 0;
      font-family: 'Courier New', Courier, monospace;
      color: #FFD700;
    }

    .card .info p {
      font-size: 30px;
      font-family: 'Courier New', Courier, monospace;
      color: #00CFC1;
    }

    .statistics {
      padding: 20px;
      width: 100%;
      margin: 0 auto;
    }

    .statistics h2 {
      font-family: 'Courier New', Courier, monospace;
      font-size: 28px;
      color: #0c5696;
      text-shadow: 1px 1px 1px #00000033;
      margin-bottom: 20px;
      text-align: start;
    }
    .time-range-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      font-family: Arial, sans-serif;
      margin-bottom: 20px;
    }

    .time-range-selector label {
      font-weight: bold;
      color: #333;
    }

    .time-range-selector input[type="datetime-local"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .time-range-selector input[type="datetime-local"]:focus {
      border-color: #008ffb;
    }

    .apply-button {
      padding: 8px 12px;
      background-color: #008ffb;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .apply-button:hover {
      background-color: #005bb5;
    }

    * {
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    .cont {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      padding: 20px;
    }

    .mail {
      grid-column: span 2;
      height: 430px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .mail {
      grid-column: span 2;
    }

    .drive {
      grid-column: span 2;
      height: 400px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .notes {
      grid-column: span 1;
      height: 397px; /* Ajusta seg√∫n tus necesidades */
      margin-top: 2px;
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 400ms ease;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }

    .notes:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.15);
    }


    /* Slider estilo */
    .hygro-slider {
      width: 100%;
      margin-bottom: 20px;
    }

    .hygrometer-card {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 260px;
      margin: auto;
    }

    svg {
      display: block;
      margin: auto;
    }

    #needle {
      transform-origin: 110px 110px;
      transition: transform 0.5s ease;
    }




    .hygro-info h3 {
      margin: 0;
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .hygro-info p {
      margin: 0;
      font-size: 1rem;
      text-align: center;
    }



    .info {
      justify-content: center;
    }

    .info h2 {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .info p {
      margin: 5px 0;
      font-size: 16px;
      color: #666;
    }
    .fw-bold {
      font-weight: bold;
    }

    @media screen and (max-width:800px) {
      .content-modal{
        width: 90%;
      }
    }

    .avatar5 {
      background-size: 100%;
      background-image: url('https://cdn-icons-png.flaticon.com/256/2100/2100100.png'); /* √çcono del term√≥metro */
      background-position: center;
      background-repeat: no-repeat;
      color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      height: 80px;
      width: 80px;
      margin-right: 20px;
    }

    .avatar5::before {
      content: '';
    }

    /* Contenedor general para las 4 cards */
    .bienestar-container {
      display: flex;
      flex-direction: column; /* Cards una debajo de otra */
      justify-content: space-between; /* Espacio entre cards */
      height: 100%; /* Ocupar el 100% de la altura */
    }

    .mini-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      height: auto; /* Ajuste autom√°tico de altura */
    }

    /* Avatar personalizado para el √≠cono */
    .mini-card .avatar.temperature-icon {
      /* Color de fondo rojo */
      background-image: url('https://cdn-icons-png.flaticon.com/256/2100/2100100.png'); /* √çcono del term√≥metro */
      background-size: 100%;
      background-position: center;
      background-repeat: no-repeat;
      width: 60px;
      height: 60px;
      margin-right: 15px;
    }

    /* Informaci√≥n de la card */
    .mini-card .info h2 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .mini-card .info .last-update {
      margin: 5px 0;
      font-size: 12px;
      color: #999;
    }

    /* Secci√≥n de temperatura */
    .mini-card .temperature {
      font-size: 24px;
      font-weight: bold;
      color: #d32f2f; /* Color rojo */
    }

    .mini-card .temperature .temp-value {
      font-family: Arial, sans-serif;
    }
    /* Estilo del Topbar */
    .topbar5 {
      background-color: #005f52; /* Color de fondo */
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      font-family: Arial, sans-serif;
    }

    .topbar5-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .topbar5 .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .topbar5 .logo small {
      display: block;
      font-size: 0.7rem;
      font-weight: normal;
      color: #e0e0e0;
    }

    .topbar5-title h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: normal;
    }

    .topbar5-expand i {
      font-size: 1.2rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="loader-container"  style="display: flex;flex-direction: column;">

    <header>
      <a href="/Inicio"><img src="/logotelecom.jpg" alt="Logo Ingenier√≠a"></a>
    </header>


    <div id="loader-wrapper"  class="loader-wrapper">

      <div class="loader">
        <div class="roller"></div>
        <div class="roller"></div>
      </div>

      <div id="loader2" class="loader">
        <div class="roller"></div>
        <div class="roller"></div>
      </div>

      <div id="loader3" class="loader">
        <div class="roller"></div>
        <div class="roller"></div>
      </div>
    </div>

  </div>
  <div id="content-show" class="hidden">
    <!-- Topbar -->
    <div class="topbar5">
      <div class="topbar5-content">
        <div class="logo">
          <span>IOT<span style="color: #f7931e;">dashboard</span></span>
          <small>By Niurka y sus amigos.</small>
        </div>
        <div class="topbar5-title">
          <h2>Monitoreo de temperatura y humedad</h2>
        </div>
        <div class="topbar5-expand">

        </div>
      </div>
    </div>
    <nav>
      <a href="/Inicio/V305"
         th:classappend="${nombreSalon == 'V305'} ? 'active' : ''">V305</a>
      <a href="/Inicio/V306"
         th:classappend="${nombreSalon == 'V306'} ? 'active' : ''">V306</a>
      <a href="/Inicio/V307"
         th:classappend="${nombreSalon == 'V307'} ? 'active' : ''">V307</a>
    </nav>


    <div class="main">
      <h2><span>TEMPERATURA Y HUMEDAD</span></h2>
      <div class="card" style="padding-bottom: 5px!important;display: flex;position: relative">
        <img id="noConexion" src="/iconNoWifi.png" alt="" style="width: 20%;position: absolute;z-index: 1000;top: 0;right: 0;display: none">
        <h3 id="temperatura" style="font-weight: bold"></h3>
        <div class="info">
          <p id="humedad" class="humidity-icon" style="font-weight: bold"></p>
        </div>
        <div style="width: 100%;justify-content: right;display: flex">
          <p id="hora"></p>
        </div>
      </div>
    </div>
    <div class="statistics">
      <h2>Gr√°ficos</h2>
      <div class="row">
        <div class="col-lg-6">
          <div class="time-range-selector">
            <span style="font-weight: bolder;font-size: 150%">Temperatura VS Tiempo</span>
            <label for="tiempoInicioGraficoTemperaturaAreas">Inicio:</label>
            <input type="datetime-local" id="tiempoInicioGraficoTemperaturaAreas">

            <label for="tiempoFinalGraficoTemperaturaAreas">Fin:</label>
            <input type="datetime-local" id="tiempoFinalGraficoTemperaturaAreas">

            <button class="apply-button" onclick="recargarGraficoTemperaturaArea()">Aplicar</button>
          </div>
          <div id="graficoTemperaturaArea"></div>
          <br>
        </div>
        <div class="col-lg-6">
          <div class="time-range-selector">
            <span style="font-weight: bolder;font-size: 150%">Humedad VS Tiempo</span>
            <label for="tiempoInicioGraficoHumedadAreas">Inicio:</label>
            <input type="datetime-local" id="tiempoInicioGraficoHumedadAreas">

            <label for="tiempoFinalGraficoHumedadAreas">Fin:</label>
            <input type="datetime-local" id="tiempoFinalGraficoHumedadAreas">

            <button class="apply-button" onclick="recargarGraficoHumedadArea()">Aplicar</button>
          </div>
          <div id="graficoHumedadArea"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6">
          <div class="row">
            <div class="time-range-selector" style="display: flex;align-items: center">
              <span style="font-weight: bolder;font-size: 150%">Promedios de temperatura por d√≠a</span>
              <label for="tiempoInicioGraficoTemperaturaBarras">Inicio:</label>
              <input type="datetime-local" id="tiempoInicioGraficoTemperaturaBarras">

              <label for="tiempoFinalGraficoTemperaturaBarras">Fin:</label>
              <input type="datetime-local" id="tiempoFinalGraficoTemperaturaBarras">

              <button class="apply-button" onclick="recargarGraficoTemperaturaBarra()">Aplicar</button>
            </div>
            <span style="font-weight: bold">Rangos: </span>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Noche (1): </span>
              <input style="width: fit-content" class="form-control" type="time" disabled value="00:00">
              <input oninput="aux(this)" style="width: fit-content" class="form-control" type="time" value="06:00" id="a_1-temperatura">
            </div>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Ma√±ana: </span>
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="06:00" type="time" id="a_2-temperatura">
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="12:00" type="time" id="b_1-temperatura">
            </div>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Tarde: </span>
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="12:00" type="time" id="b_2-temperatura">
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="18:00" type="time" id="c_1-temperatura">
            </div>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Noche (2): </span>
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="18:00" type="time" id="c_2-temperatura">
              <input style="width: fit-content" class="form-control" type="time" disabled value="23:59">
            </div>
          </div>
          <div id="graficoTemperaturaPromedios"></div>
          <br>
        </div>
        <div class="col-lg-6">
          <div class="row">
            <div class="time-range-selector" style="display: flex;align-items: center">
              <span style="font-weight: bolder;font-size: 150%">Promedios de humedad por d√≠a</span>
              <label for="tiempoInicioGraficoHumedadBarras">Inicio:</label>
              <input type="datetime-local" id="tiempoInicioGraficoHumedadBarras">

              <label for="tiempoFinalGraficoHumedadBarras">Fin:</label>
              <input type="datetime-local" id="tiempoFinalGraficoHumedadBarras">

              <button class="apply-button" onclick="recargarGraficoHumedadBarra()">Aplicar</button>
            </div>
            <span style="font-weight: bold">Rangos: </span>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Noche (1): </span>
              <input style="width: fit-content" class="form-control" type="time" disabled value="00:00">
              <input oninput="aux(this)" style="width: fit-content" class="form-control" type="time" value="06:00" id="a_1-humedad">
            </div>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Ma√±ana: </span>
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="06:00" type="time" id="a_2-humedad">
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="12:00" type="time" id="b_1-humedad">
            </div>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Tarde: </span>
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="12:00" type="time" id="b_2-humedad">
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="18:00" type="time" id="c_1-humedad">
            </div>
            <div class="col-6" style="display: flex;justify-content: space-around">
              <span>Noche (2): </span>
              <input oninput="aux(this)" style="width: fit-content" class="form-control" value="18:00" type="time" id="c_2-humedad">
              <input style="width: fit-content" class="form-control" type="time" disabled value="23:59">
            </div>
          </div>
          <div id="graficoHumedadPromedios"></div>
          <br>
        </div>
      </div>
    </div>
    <div class="statistics">
      <h2>Estad√≠sticas</h2>

      <div class="table-responsive">
        <table class="table table-bordered table-hover table-striped" id="tableSupreme">
          <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Nombre Dispositivo</th>
            <th>Timestamp</th>
            <th>Temperatura</th>
            <th>Humedad</th>
          </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>


  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.all.min.js"></script>

  <script th:inline="javascript">
    const salonActivo=/*[[${nombreSalon}]]*/;
    let datos;
    let mTemperaturaArea;
    let bTemperaturaArea;
    let mHumedadArea;
    let bHumedadArea;
    let chartTemperaturaArea;
    let chartHumedadArea;
    let tiempoInicialChartTemperaturaArea;
    let tiempoFinalChartTemperaturaArea;
    let tiempoInicialChartHumedadArea;
    let tiempoFinalChartHumedadArea;
    const DateTime = luxon.DateTime;
    let timeout;
    const limiteSinRecibirDatos=20;

    let chartTemperaturaBarra;
    let chartHumedadBarra;

    // Funci√≥n para obtener la fecha y hora actual en formato 'YYYY-MM-DDTHH:MM'
    function obtenerFechaActual() {
      const ahora = new Date();
      const anio = ahora.getFullYear();
      const mes = String(ahora.getMonth() + 1).padStart(2, '0'); // Mes: 01-12
      const dia = String(ahora.getDate()).padStart(2, '0');      // D√≠a: 01-31
      const horas = String(ahora.getHours()).padStart(2, '0');
      const minutos = String(ahora.getMinutes()).padStart(2, '0');

      return `${anio}-${mes}-${dia}T${horas}:${minutos}`;
    }

    // Funci√≥n para obtener la fecha y hora hace exactamente 1 d√≠a en formato 'YYYY-MM-DDTHH:MM'
    function obtenerFechaHaceUnDia() {
      const haceUnDia = new Date();
      haceUnDia.setDate(haceUnDia.getDate() - 1); // Restar 1 d√≠a
      const anio = haceUnDia.getFullYear();
      const mes = String(haceUnDia.getMonth() + 1).padStart(2, '0');
      const dia = String(haceUnDia.getDate()).padStart(2, '0');
      const horas = String(haceUnDia.getHours()).padStart(2, '0');
      const minutos = String(haceUnDia.getMinutes()).padStart(2, '0');

      return `${anio}-${mes}-${dia}T${horas}:${minutos}`;
    }

    function ejecutarAccionInactividad() {
      Swal.fire({
        title: 'No se ha recibido ning√∫n dato hace '+limiteSinRecibirDatos+' segundos',
        text: 'Es posible que el dispositivo haya perdido conexi√≥n a Internet, o no se encuentre en funcionamiento',
        icon: 'error',
        confirmButtonText: 'Entendido',
      });
      $("#noConexion").show();
    }

    function reiniciarContadorSinConexion() {
      $("#noConexion").hide();
      if (timeout) {
        clearTimeout(timeout);
      }

      timeout = setTimeout(ejecutarAccionInactividad, limiteSinRecibirDatos*1000);
    }

    reiniciarContadorSinConexion();

    function calcularRegresionLineal(expresion) {
      const datosFiltrados=obtenerDatosFiltrados(expresion);
      const n = datos.length;
      let sumaX = 0, sumaY = 0, sumaXY = 0, sumaX2 = 0;

      if(expresion=="Temperatura"){
        datosFiltrados.forEach((punto) => {
          const x = new Date(punto.timestamp).getTime();
          const y = punto.temperatura;
          sumaX += x;
          sumaY += y;
          sumaXY += x * y;
          sumaX2 += x * x;
        });
        mTemperaturaArea = (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
        bTemperaturaArea = (sumaY - mTemperaturaArea * sumaX) / n;
      }else if(expresion=="Humedad"){
        datosFiltrados.forEach((punto) => {
          const x = new Date(punto.timestamp).getTime();
          const y = punto.humedad;
          sumaX += x;
          sumaY += y;
          sumaXY += x * y;
          sumaX2 += x * x;
        });
        mHumedadArea= (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
        bHumedadArea = (sumaY - mHumedadArea * sumaX) / n;
      }
    }

    function generarPuntosRegresion(m,b,datosLocales) {
      if(datosLocales.length!=0){
        const xInicio = new Date(datosLocales[0].timestamp).getTime();
        const xFin = new Date(datosLocales[datosLocales.length - 1].timestamp).getTime();
        const yInicio = m * xInicio + b;
        const yFin = m * xFin + b;
        return [
          { x: obtenerHoraTimestamp(datosLocales[0].timestamp), y: yInicio },
          { x: obtenerHoraTimestamp(datosLocales[datosLocales.length - 1].timestamp), y: yFin }
        ];
      }else {
        return {x:0,y:0}
      }
    }


    function obtenerDatosFiltrados(expresion){
      if(expresion=="Temperatura"){
        tiempoInicialChartTemperaturaArea=$("#tiempoInicioGraficoTemperaturaAreas").val();
        tiempoFinalChartTemperaturaArea=$("#tiempoFinalGraficoTemperaturaAreas").val();
        if(tiempoInicialChartTemperaturaArea&&tiempoFinalChartTemperaturaArea){
          return datos.filter(dato => {
            const timestamp = new Date(dato.timestamp).getTime();
            return timestamp >= new Date(tiempoInicialChartTemperaturaArea).getTime() && timestamp <= new Date(tiempoFinalChartTemperaturaArea).getTime();
          });
        }else {
          return datos;
        }
      }else if(expresion=="Humedad"){
        tiempoInicialChartHumedadArea=$("#tiempoInicioGraficoHumedadAreas").val();
        tiempoFinalChartHumedadArea=$("#tiempoFinalGraficoHumedadAreas").val();
        if(tiempoInicialChartHumedadArea&&tiempoFinalChartHumedadArea){
          return datos.filter(dato => {
            const timestamp = new Date(dato.timestamp).getTime();
            return timestamp >= new Date(tiempoInicialChartHumedadArea).getTime() && timestamp <= new Date(tiempoFinalChartHumedadArea).getTime();
          });
        }else {
          return datos;
        }
      }
    }

    function obtenerDatosFiltradosBarra(expresion){
      if(expresion=="Temperatura"){
        tiempoInicialChartTemperaturaArea=$("#tiempoInicioGraficoTemperaturaBarras").val();
        tiempoFinalChartTemperaturaArea=$("#tiempoFinalGraficoTemperaturaBarras").val();
        if(tiempoInicialChartTemperaturaArea&&tiempoFinalChartTemperaturaArea){
          return datos.filter(dato => {
            const timestamp = new Date(dato.timestamp).getTime();
            return timestamp >= new Date(tiempoInicialChartTemperaturaArea).getTime() && timestamp <= new Date(tiempoFinalChartTemperaturaArea).getTime();
          });
        }else {
          return datos;
        }
      }else if(expresion=="Humedad"){
        tiempoInicialChartHumedadArea=$("#tiempoInicioGraficoHumedadBarras").val();
        tiempoFinalChartHumedadArea=$("#tiempoFinalGraficoHumedadBarras").val();
        if(tiempoInicialChartHumedadArea&&tiempoFinalChartHumedadArea){
          return datos.filter(dato => {
            const timestamp = new Date(dato.timestamp).getTime();
            return timestamp >= new Date(tiempoInicialChartHumedadArea).getTime() && timestamp <= new Date(tiempoFinalChartHumedadArea).getTime();
          });
        }else {
          return datos;
        }
      }
    }

    function recargarGraficoTemperaturaArea(){
      if(chartTemperaturaArea==null){
        cargarGraficoTemperaturaArea();
      }else {
        const datosLocales=obtenerDatosFiltrados("Temperatura");
        calcularRegresionLineal("Temperatura");

        chartTemperaturaArea.updateSeries([{
          name: 'Temperatura (C¬∞)',
          data: datosLocales.map(function (dato){
            return {x:obtenerHoraTimestamp(dato.timestamp),y:dato.temperatura}
          })
        },
          {
            name: `Tendencia ${mTemperaturaArea < 0 ? "(disminuir" : "(aumentar"} ${Math.abs(mTemperaturaArea * 36000000).toFixed(2)} C¬∞ cada hora)`,
            data: generarPuntosRegresion(mTemperaturaArea,bTemperaturaArea,datosLocales),
            type: 'line'
          }]);
      }
    }

    function recargarGraficoHumedadArea(){
      if(chartHumedadArea==null){
        cargarGraficoHumedadArea();
      }else {
        const datosLocales=obtenerDatosFiltrados("Humedad");
        calcularRegresionLineal("Humedad");
        chartHumedadArea.updateSeries([{
          name: 'Humedad (%)',
          data: datosLocales.map(function (dato){
            return {x:obtenerHoraTimestamp(dato.timestamp),y:dato.humedad}
          })
        },
          {
            name: `Tendencia ${mHumedadArea < 0 ? "(disminuir " : "(aumentar "} ${Math.abs(mHumedadArea * 36000000).toFixed(2)}% cada hora)`,
            data: generarPuntosRegresion(mHumedadArea,bHumedadArea,datosLocales),
            type: 'line'
          }]);
      }
    }

    function cargarGraficoTemperaturaArea(){
      calcularRegresionLineal("Temperatura");
      const puntosRegresion = generarPuntosRegresion(mTemperaturaArea, bTemperaturaArea,datos);
      let tendencia;
      if(mTemperaturaArea<0){
        tendencia="Tendencia (disminuir "+(mTemperaturaArea*-36000000).toFixed(2)+" C¬∞ cada hora)";
      }else {
        tendencia="Tendencia (aumentar "+(mTemperaturaArea*36000000).toFixed(2)+" C¬∞ cada hora)";
      }

      const options = {
        chart: {
          type: 'area',
          height: 350,
          toolbar: {
            show: true
          }
        },
        series: [
          {
            name: 'Temperatura (C¬∞)',
            data: datos.map(function (dato){
              return {x:obtenerHoraTimestamp(dato.timestamp),y:dato.temperatura}
          }),
            fill: {
              type: 'gradient',
              gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.3
              }
            }
          },
          {
            name: tendencia,
            data: puntosRegresion,
            type: 'line',
            stroke: {
              curve: 'straight'
            },
            gradient: {
              shadeIntensity: 2,
              colorStops: [
                {
                  offset: 0,
                  color: '#00b894',
                },
                {
                  offset: 100,
                  color: '#00b894',
                }
              ]
            }
          }],
        xaxis: {
          type: 'datetime',
          title: {
            text: 'Tiempo'
          },
          labels: {
            format: 'HH:mm'
          }
        },
        yaxis: {
          title: {
            text: 'Temperatura (¬∞C)'
          },
          decimalsInFloat: 1
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          width: [3, 5]
        },
        tooltip: {
          x: {
            format: 'dd MMM HH:mm'
          },
          y: {
            formatter: function (val) {
              return val.toFixed(2) + ' ¬∞C';
            },
          },
        }
      };

      chartTemperaturaArea = new ApexCharts(document.querySelector("#graficoTemperaturaArea"), options);
      chartTemperaturaArea.render();
    }

    function aux(ola){
      const id=ola.id;
      switch (id){
        case "a_1-temperatura":
          $("#a_2-temperatura").val(ola.value);
          break;
        case "a_2-temperatura":
          $("#a_1-temperatura").val(ola.value);
          break;
        case "b_1-temperatura":
          $("#b_2-temperatura").val(ola.value);
          break;
        case "b_2-temperatura":
          $("#b_1-temperatura").val(ola.value);
          break;
        case "c_1-temperatura":
          $("#c_2-temperatura").val(ola.value);
          break;
        case "c_2-temperatura":
          $("#c_1-temperatura").val(ola.value);
          break;
        case "a_1-humedad":
          $("#a_2-humedad").val(ola.value);
          break;
        case "a_2-humedad":
          $("#a_1-humedad").val(ola.value);
          break;
        case "b_1-humedad":
          $("#b_2-humedad").val(ola.value);
          break;
        case "b_2-humedad":
          $("#b_1-humedad").val(ola.value);
          break;
        case "c_1-humedad":
          $("#c_2-humedad").val(ola.value);
          break;
        case "c_2-humedad":
          $("#c_1-humedad").val(ola.value);
          break;
      }
    }

    function validarRangoCorrectoTemperatura() {
      const a1=$("#a_1-temperatura").val();
      const a2=$("#a_2-temperatura").val();
      const b1=$("#b_1-temperatura").val();
      const b2=$("#b_2-temperatura").val();
      const c1=$("#c_1-temperatura").val();
      const c2=$("#c_2-temperatura").val();
      if(a1!=a2||b1!=b2||c1!=c2||a1>b1||b1>c1){
        return false;
      }else {
        return true;
      }
    }

    function validarRangoCorrectoHumedad() {
      const a1=$("#a_1-humedad").val();
      const a2=$("#a_2-humedad").val();
      const b1=$("#b_1-humedad").val();
      const b2=$("#b_2-humedad").val();
      const c1=$("#c_1-humedad").val();
      const c2=$("#c_2-humedad").val();
      if(a1!=a2||b1!=b2||c1!=c2||a1>b1||b1>c1){
        return false;
      }else {
        return true;
      }
    }

    function cargarGraficoHumedadArea(){
      calcularRegresionLineal("Humedad");
      const puntosRegresion = generarPuntosRegresion(mHumedadArea, bHumedadArea,datos);
      let tendencia;
      if(mHumedadArea<0){
        tendencia="Tendencia (disminuir "+(mHumedadArea*-3600000).toFixed(2)+"% cada hora)";
      }else {
        tendencia="Tendencia (dumentar "+(mHumedadArea*3600000).toFixed(2)+"% cada hora)";
      }

      const options = {
        chart: {
          type: 'area',
          height: 350,
          toolbar: {
            show: true
          }
        },
        colors: ['#FFA500', '#8B4513'],
        series: [
          {
            name: 'Humedad (%)',
            data: datos.map(function (dato){
              return {x:obtenerHoraTimestamp(dato.timestamp),y:dato.humedad}
            }),
            fill: {
              type: 'gradient',
              gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.3
              }
            }
          },
          {
            name: tendencia,
            data: puntosRegresion,
            type: 'line',
            stroke: {
              curve: 'straight'
            },
            gradient: {
              shadeIntensity: 2,
              colorStops: [
                {
                  offset: 0,
                  color: '#00b894',
                },
                {
                  offset: 100,
                  color: '#00b894',
                }
              ]
            }
          }],
        xaxis: {
          type: 'datetime',
          title: {
            text: 'Tiempo'
          },
          labels: {
            format: 'HH:mm'
          }
        },
        yaxis: {
          title: {
            text: 'Humedad (%)'
          },
          decimalsInFloat: 1
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          width: [3, 5]
        },
        tooltip: {
          x: {
            format: 'dd MMM HH:mm'
          }
        }
      };

      chartHumedadArea = new ApexCharts(document.querySelector("#graficoHumedadArea"), options);
      chartHumedadArea.render();
    }
    function obtenerHoraTimestamp(horaDateTime){
      return DateTime.fromFormat(horaDateTime, 'yyyy-MM-dd HH:mm:ss', { zone: 'UTC' }).toMillis();
    }

    tabla=$("#tableSupreme").DataTable({
      'paging': true,
      "pageLength": 10,
      "language": {
        "lengthMenu": "Mostrar _MENU_ entradas por p√°gina",
        "zeroRecords": "No se encontraron registros",
        "infoEmpty": "No hay registros disponibles",
        "infoFiltered": "(filtrado de _MAX_ total registros)",
        "search": "Buscar:",
        "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
        emptyTable: "A√∫n no existe alg√∫n dato registrado",
        "paginate": {
          "previous": "<",
          "next": ">",
        }
      },
      'lengthChange': true,
      'lengthMenu': [  [10, 25, 50, 100, -1]  ,  [10, 25, 50, 100, "Todas"]  ],
      "buttons": ['pageLength'],
      'searching': true,
      'ordering': true,
      'info': true,
      'autoWidth': false,
    });

    let temperatura=null;
    let humedad=null;
    /*document.addEventListener('DOMContentLoaded',  ()=>{
      setInterval(miFuncion, 20000);
    });*/
    let ultimoElementoSupreme;
    function obtenerDatos(){
      return new Promise((resolve,reject)=>{
        $.ajax({
          url: "/datosPorSalon/"+salonActivo,
          method: "GET",
          success: function (response) {
            resolve(response.content);
          },
          error: function (xhr, status, error) {
            reject(error);
          }
        });
      })
    }

    async function cargarPagina(){
      $("#tiempoFinalGraficoHumedadAreas").val(obtenerFechaActual());
      $("#tiempoFinalGraficoTemperaturaAreas").val(obtenerFechaActual());
      $("#tiempoInicioGraficoHumedadAreas").val(obtenerFechaHaceUnDia());
      $("#tiempoInicioGraficoTemperaturaAreas").val(obtenerFechaHaceUnDia());

      datos=await obtenerDatos();
      for(let i=0;i<datos.length;i++){
        agregarFila(datos[i]);
      }
      const ultimoDato=datos[datos.length-1];
      recibirDato(ultimoDato);
      cargarGraficoTemperaturaArea();
      cargarGraficoHumedadArea();
      recargarGraficoTemperaturaArea()
      recargarGraficoHumedadArea()

      recargarGraficoTemperaturaBarra();
      recargarGraficoHumedadBarra()
    }
    cargarPagina();

    function cargarDatosPorSalon(salon) {
      $.ajax({
        url: "/datosPorSalon/" + salonActivo,
        method: "GET",
        success: function(response) {
          if (response.status === "success") {
            const datos = response.content;

            tabla.clear();

            datos.forEach((dato, index) => {
              tabla.row.add([
                index + 1,
                dato.idDispositivo || "N/A",
                dato.timestamp,
                dato.temperatura,
                dato.humedad
              ]);
            });

            tabla.draw();

            actualizarGraficos(datos);
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error("Estado del error:", textStatus);
          console.error("Error lanzado:", errorThrown);
          console.error("Respuesta del servidor:", jqXHR.responseText);

          // Mostrar un mensaje detallado al usuario (opcional)
          Swal.fire(
                  "Error 500",
                  "No se pudieron cargar los datos del sal√≥n. Detalles: " + jqXHR.responseText,
                  "error"
          );
        }
      });
    }


    function actualizarGraficos(datos) {
      const temperaturas = datos.map(dato => ({ x: dato.timestamp, y: dato.temperatura }));
      const humedades = datos.map(dato => ({ x: dato.timestamp, y: dato.humedad }));

      chartTemperaturaArea.updateSeries([{ data: temperaturas }]);
      chartHumedadArea.updateSeries([{ data: humedades }]);
    }


    function agregarFila(elemento) {
      tabla.row.add([
              elemento.id,
              elemento.idDispositivo,
              formatDate(elemento.timestamp),
              elemento.temperatura+"¬∞C",
              elemento.humedad+"%"
      ]).draw(false);
      tabla.order([2, 'desc']).draw();
    }

    let stompClient = null;
    function connect() {
      let socket = new SockJS('/message');
      stompClient = Stomp.over(socket);
      stompClient.connect({}, function (frame) {
        stompClient.subscribe('/topic/recibirDato', function (messageOutput) {
          const nuevoDato=JSON.parse(messageOutput.body).dato;
          const nuevoSalon=JSON.parse(messageOutput.body).salon;

          if (nuevoSalon === salonActivo) {
            recibirDato(nuevoDato);
            agregarFila(nuevoDato);
            datos.push(nuevoDato);
            recargarGraficoTemperaturaArea()
            recargarGraficoHumedadArea()
            reiniciarContadorSinConexion();
          }
          });
      });
    }



    function formatDate(datetime) {
      const [datePart, timePart] = datetime.split(' ');
      const [year, month, day] = datePart.split('-');
      const [hours, minutes, seconds] = timePart.split(':');
      return `${day}/${month}/${year.slice(-2)} - ${hours}:${minutes}:${seconds}`;
    }

    function recibirDato(dato){
      const temperaturaRecibida=dato.temperatura;
      const humedadRecibida=dato.humedad;
      const elementoTemperatura=$("#temperatura");
      const elementoHumedad=$("#humedad");
      const elementoHora=$("#hora");
      if(temperaturaRecibida>30){
        elementoTemperatura.text("üî• "+temperaturaRecibida+"¬∞C");
      }else if(temperaturaRecibida>24){
        elementoTemperatura.text("‚òÄÔ∏è "+temperaturaRecibida+"¬∞C");
      }else if(temperaturaRecibida>18){
        elementoTemperatura.text("üå§Ô∏è "+temperaturaRecibida+"¬∞C");
      }else{
        elementoTemperatura.text("üßä "+temperaturaRecibida+"¬∞C");
      }

      if(humedadRecibida>80){
        elementoHumedad.text("üåßÔ∏è "+humedadRecibida+"%");
      }else if(humedadRecibida>70){
        elementoHumedad.text("üå´Ô∏è "+humedadRecibida+"%");
      }else if(humedadRecibida>40){
        elementoHumedad.text("üíß "+humedadRecibida+"%");
      }else{
        elementoHumedad.text("üåµ "+humedadRecibida+"%");
      }

      elementoHora.text("Muestra tomada el: "+formatDate(dato.timestamp));

    }
    connect();


    // Funci√≥n para procesar los datos
    function procesarDatos(datos, rangoManana, rangoTarde) {
      const { a: inicioManana, b: finManana } = rangoManana;
      const { b: inicioTarde, c: finTarde } = rangoTarde;

      // Objeto para almacenar las temperaturas por d√≠a y rango
      const resultados = {};


      datos.forEach(({ temperatura, timestamp }) => {
        const fechaCompleta = new Date(timestamp);
        const dia = fechaCompleta.toISOString().split('T')[0]; // Obtiene solo el d√≠a (YYYY-MM-DD)
        const hora = fechaCompleta.getHours() + fechaCompleta.getMinutes() / 60;

        if (!resultados[dia]) {
          resultados[dia] = {
            manana: [],
            tarde: [],
            noche: [],
          };
        }

        if (hora >= inicioManana && hora < finManana) {
          resultados[dia].manana.push(temperatura);
        } else if (hora >= inicioTarde && hora < finTarde) {
          resultados[dia].tarde.push(temperatura);
        } else {
          resultados[dia].noche.push(temperatura);
        }
      });

      // Calcula los promedios por d√≠a y rango
      const dias = Object.keys(resultados);
      const promedios = dias.map((dia) => {
        const { manana, tarde, noche } = resultados[dia];

        return {
          dia,
          manana: promedio(manana),
          tarde: promedio(tarde),
          noche: promedio(noche),
        };
      });

      return promedios;
    }

    // Funci√≥n para calcular el promedio de un arreglo
    function promedio(arreglo) {
      if (arreglo.length === 0) return 0;
      const suma = arreglo.reduce((acc, val) => acc + val, 0);
      return suma / arreglo.length;
    }

    function recargarGraficoTemperaturaBarra() {
      if(validarRangoCorrectoTemperatura()){
        const a = convertirHoraADecimal($("#a_1-temperatura").val());
        const b = convertirHoraADecimal($("#b_1-temperatura").val());
        const c = convertirHoraADecimal($("#c_1-temperatura").val());

        const rangoManana = { a: a, b: b }; // 6:00 a 12:00
        const rangoTarde = { b: b, c: c }; // 12:00 a 18:00

        const datosFiltrados = obtenerDatosFiltradosBarra("Temperatura").slice().reverse();
        const promedios = procesarDatos(datosFiltrados, rangoManana, rangoTarde);

        const categorias = promedios.length ? promedios.map((p) => p.dia) : ["Sin datos"];
        const dataManana = promedios.length ? promedios.map((p) => p.manana || 0) : [0];
        const dataTarde = promedios.length ? promedios.map((p) => p.tarde || 0) : [0];
        const dataNoche = promedios.length ? promedios.map((p) => p.noche || 0) : [0];


        const options = {
          series: [
            { name: 'Ma√±ana', data: dataManana, type: 'bar', group: 'apexcharts-axis-0' },
            { name: 'Tarde', data: dataTarde, type: 'bar', group: 'apexcharts-axis-0' },
            { name: 'Noche', data: dataNoche, type: 'bar', group: 'apexcharts-axis-0' },
          ],
          xaxis: {
            categories: categorias,
          },
        };
        const isSeriesValid = options.series.every((serie) => Array.isArray(serie.data) && serie.data.length > 0);

        if (!isSeriesValid) {
          console.warn("Las series tienen datos inv√°lidos:", options.series);
          return; // No actualices si los datos son inv√°lidos
        }
        console.log("Opciones enviadas a ApexCharts:", options);
        console.log("Categor√≠as:", categorias);
        console.log("Serie Ma√±ana:", dataManana);
        console.log("Serie Tarde:", dataTarde);
        console.log("Serie Noche:", dataNoche);
        console.log("Promedios: ",promedios);
        console.log("Datos filtrados",datosFiltrados)
        // Si la gr√°fica ya existe, actualiza los datos
        if (chartTemperaturaBarra) {
          chartTemperaturaBarra.destroy();
        }
        chartTemperaturaBarra = new ApexCharts(document.querySelector("#graficoTemperaturaPromedios"), {
          ...options,
          chart: { type: 'bar', height: 350 },
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: '55%',
              borderRadius: 5,
              borderRadiusApplication: 'end',
            },
          },
          dataLabels: { enabled: false },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent'],
          },
          yaxis: {
            title: { text: 'Temperatura (¬∞C)' },
            decimalsInFloat: 1,
          },
          fill: { opacity: 1 },
          tooltip: {
            y: {
              formatter: function (val) {
                return val.toFixed(2) + ' ¬∞C';
              },
            },
          },
        });
        chartTemperaturaBarra.render();

      }else {
        Swal.fire({
          title: 'Error al aplicar filtros',
          text: 'Ingrese los filtros de rango correctamente',
          icon: 'error',
          confirmButtonText: 'Entendido',
        });
      }
    }

    function recargarGraficoHumedadBarra() {
      if(validarRangoCorrectoHumedad()){

        const a = convertirHoraADecimal($("#a_1-humedad").val());
        const b = convertirHoraADecimal($("#b_1-humedad").val());
        const c = convertirHoraADecimal($("#c_1-humedad").val());

        const rangoManana = { a: a, b: b }; // 6:00 a 12:00
        const rangoTarde = { b: b, c: c }; // 12:00 a 18:00


        console.log(rangoManana,rangoTarde)

        const datosFiltrados = obtenerDatosFiltradosBarra("Humedad").slice().reverse();
        datosFiltrados.reverse();
        const promedios = procesarDatos(datosFiltrados, rangoManana, rangoTarde);
        const categorias = promedios.length ? promedios.map((p) => p.dia) : ["Sin datos"];
        const dataManana = promedios.length ? promedios.map((p) => p.manana || 0) : [0];
        const dataTarde = promedios.length ? promedios.map((p) => p.tarde || 0) : [0];
        const dataNoche = promedios.length ? promedios.map((p) => p.noche || 0) : [0];


        const options = {
          series: [
            { name: 'Ma√±ana', data: dataManana, type: 'bar', group: 'apexcharts-axis-0' },
            { name: 'Tarde', data: dataTarde, type: 'bar', group: 'apexcharts-axis-0' },
            { name: 'Noche', data: dataNoche, type: 'bar', group: 'apexcharts-axis-0' },
          ],
          xaxis: {
            categories: categorias,
          },
        };

        const isSeriesValid = options.series.every((serie) => Array.isArray(serie.data) && serie.data.length > 0);

        if (!isSeriesValid) {
          console.warn("Las series tienen datos inv√°lidos:", options.series);
          return; // No actualices si los datos son inv√°lidos
        }
        console.log("Opciones enviadas a ApexCharts:", options);
        console.log("Categor√≠as:", categorias);
        console.log("Serie Ma√±ana:", dataManana);
        console.log("Serie Tarde:", dataTarde);
        console.log("Serie Noche:", dataNoche);
        // Si la gr√°fica ya existe, actualiza los datos
        if (chartHumedadBarra) {
          chartHumedadBarra.destroy();
        }
        // Si no existe, inicializa la gr√°fica
        chartHumedadBarra = new ApexCharts(document.querySelector("#graficoHumedadPromedios"), {
          ...options,
          chart: { type: 'bar', height: 350 },
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: '55%',
              borderRadius: 5,
              borderRadiusApplication: 'end',
            },
          },
          dataLabels: { enabled: false },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent'],
          },
          yaxis: {
            title: { text: 'Humedad (%)' },
            decimalsInFloat: 1,
          },
          fill: { opacity: 1 },
          tooltip: {
            y: {
              formatter: function (val) {
                return val.toFixed(2) + ' %';
              },
            },
          },
        });
        chartHumedadBarra.render();
      }else {
        Swal.fire({
          title: 'Error al aplicar filtros',
          text: 'Ingrese los filtros de rango correctamente',
          icon: 'error',
          confirmButtonText: 'Entendido',
        });
      }
    }

    function convertirHoraADecimal(hora) {
      const [hh, mm] = hora.split(':').map(Number); // Separa HH y MM y los convierte a n√∫mero
      return hh + mm / 60; // Convierte a formato decimal
    }

  </script>


</body>
</html>

